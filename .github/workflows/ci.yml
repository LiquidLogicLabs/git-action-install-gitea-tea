name: CI

on:
  push:
    paths-ignore: ['**/*.md']
    branches: ['**']
    tags-ignore: ['**']  # Ignore tag pushes (handled by release workflow)
  pull_request:
    paths-ignore: ['**/*.md']
    branches: ['**']
  workflow_call:  # Allow CI to be called by release workflow
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: ${{ github.workflow || 'CI' }}-${{ github.event.pull_request.number || github.ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  lint:
    # No conditions needed - workflow trigger handles filtering
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint shell script
        run: |
          shellcheck install-tea.sh || {
            echo "Shellcheck found issues. Please fix them."
            exit 1
          }

      - name: Validate action.yml
        run: |
          # Basic validation that action.yml exists and is valid YAML
          if [ ! -f action.yml ]; then
            echo "action.yml not found"
            exit 1
          fi
          # Validate YAML when PyYAML is available (e.g. GitHub runner); skip in act when not present
          if python3 -c "import yaml" 2>/dev/null; then
            python3 -c "import yaml; yaml.safe_load(open('action.yml'))" || {
              echo "action.yml is not valid YAML"
              exit 1
            }
            echo "action.yml is valid YAML"
          else
            echo "Skipping YAML parse check (PyYAML not installed); action.yml exists"
          fi

      - name: Verify script is executable
        run: |
          if [ ! -x install-tea.sh ]; then
            echo "install-tea.sh is not executable"
            exit 1
          fi

  test:
    # No conditions needed - workflow trigger handles filtering
    needs: lint  # Tests run after lint
    uses: ./.github/workflows/test.yml
    secrets: inherit
    # test.yml runs: unit tests + integration tests (all tests except E2E)
