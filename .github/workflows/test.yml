name: Test

on:
  workflow_call:  # Called by CI workflow
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: ${{ github.workflow || 'Test' }}-${{ github.event.pull_request.number || github.ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    # Always run - this workflow only has workflow_call and workflow_dispatch triggers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Test the action directly with default values
      - name: Test - Default values
        id: test-default
        uses: ./
        continue-on-error: true

      - name: Verify default test results
        run: |
          if [ "${{ steps.test-default.outcome }}" != "success" ]; then
            echo "Default test failed, but this is expected if no token is provided"
          else
            echo "✓ Default test passed"
            echo "Binary path: ${{ steps.test-default.outputs.binary-path }}"
            echo "Version: ${{ steps.test-default.outputs.version }}"
          fi

      # Test with explicit version
      - name: Test - Explicit version
        id: test-version
        uses: ./
        with:
          version: '0.9.0'
        continue-on-error: true

      - name: Verify version test results
        run: |
          if [ "${{ steps.test-version.outcome }}" != "success" ]; then
            echo "Version test failed"
            exit 1
          fi
          echo "✓ Version test passed"
          if [ -n "${{ steps.test-version.outputs.version }}" ]; then
            echo "Installed version: ${{ steps.test-version.outputs.version }}"
          fi

      # Test with custom repo URL
      - name: Test - Custom repo URL
        id: test-repo
        uses: ./
        with:
          repo: 'https://gitea.com'
        continue-on-error: true

      - name: Verify repo test results
        run: |
          if [ "${{ steps.test-repo.outcome }}" != "success" ]; then
            echo "Repo test failed, but this is expected if no token is provided"
          else
            echo "✓ Repo test passed"
          fi

      # Verify binary is accessible
      - name: Verify binary in PATH
        run: |
          if command -v tea &> /dev/null; then
            echo "✓ tea is in PATH"
            tea --version || echo "tea --version failed (expected if not authenticated)"
          else
            echo "✗ tea is not in PATH"
            exit 1
          fi

      # Verify binary path output
      - name: Verify binary path output
        run: |
          if [ -f "/usr/local/bin/tea" ]; then
            echo "✓ Binary exists at /usr/local/bin/tea"
            /usr/local/bin/tea --version || echo "Binary exists but may not be functional"
          else
            echo "✗ Binary does not exist at /usr/local/bin/tea"
            exit 1
          fi

      - name: Test Summary
        run: |
          echo "## ✅ Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Binary location: \`/usr/local/bin/tea\`" >> $GITHUB_STEP_SUMMARY
          echo "- Binary is in PATH: ✅" >> $GITHUB_STEP_SUMMARY
